<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω s·∫£n ph·∫©m - GOOJODOQ Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1><i class="fas fa-box me-2"></i>Qu·∫£n l√Ω s·∫£n ph·∫©m</h1>
                    <div>
                        <a href="add-product.html" class="btn btn-success me-2">
                            <i class="fas fa-plus me-2"></i>Th√™m s·∫£n ph·∫©m
                        </a>
                        <a href="index.html" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Quay l·∫°i
                        </a>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="productsTable">
                                <thead>
                                    <tr>
                                        <th width="5%">ID</th>
                                        <th width="10%">H√¨nh ·∫£nh</th>
                                        <th width="30%">T√™n s·∫£n ph·∫©m</th>
                                        <th width="15%">Gi√°</th>
                                        <th width="10%">T·ªìn kho</th>
                                        <th width="10%">Tr·∫°ng th√°i</th>
                                        <th width="20%">Thao t√°c</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="7" class="text-center">ƒêang t·∫£i d·ªØ li·ªáu...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal s·ª≠a s·∫£n ph·∫©m -->
    <div class="modal fade" id="editProductModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Ch·ªânh s·ª≠a s·∫£n ph·∫©m</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editProductForm">
                        <input type="hidden" id="edit_product_id">
                        
                        <div class="row g-3">
                            <div class="col-md-8">
                                <label class="form-label fw-bold">T√™n s·∫£n ph·∫©m <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="edit_product_name" required>
                            </div>
                            
                            <div class="col-md-4">
                                <label class="form-label fw-bold">SKU <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="edit_sku" required>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Danh m·ª•c <span class="text-danger">*</span></label>
                                <select class="form-select" id="edit_category_id" required>
                                    <option value="">Ch·ªçn danh m·ª•c</option>
                                    <option value="1">Tai nghe Bluetooth</option>
                                    <option value="2">Loa Bluetooth</option>
                                    <option value="3">Ph·ª• ki·ªán ƒëi·ªán tho·∫°i</option>
                                    <option value="4">S·∫°c d·ª± ph√≤ng</option>
                                    <option value="5">C√°p s·∫°c</option>
                                    <option value="6">·ªêp l∆∞ng</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label fw-bold">T·ªìn kho <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="edit_stock_quantity" required min="0">
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Gi√° g·ªëc (VNƒê) <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="edit_price" required min="0" step="1000">
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Gi√° khuy·∫øn m√£i (VNƒê)</label>
                                <input type="number" class="form-control" id="edit_sale_price" min="0" step="1000">
                            </div>
                            
                            <div class="col-12">
                                <label class="form-label fw-bold">M√¥ t·∫£ ng·∫Øn <span class="text-danger">*</span></label>
                                <textarea class="form-control" id="edit_short_description" rows="2" required></textarea>
                            </div>
                            
                            <div class="col-12">
                                <label class="form-label fw-bold">M√¥ t·∫£ chi ti·∫øt <span class="text-danger">*</span></label>
                                <textarea class="form-control" id="edit_description" rows="4" required></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="button" class="btn btn-primary" onclick="saveProductEdit()">
                        <i class="fas fa-save me-2"></i>L∆∞u thay ƒë·ªïi
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/main.js"></script>
    <script>
        // Check if user is admin (currentUser ƒë√£ ƒë∆∞·ª£c khai b√°o trong main.js)
        if (!currentUser || currentUser.quyen !== 'admin') {
            alert('B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y!');
            window.location.href = 'index.html';
        }

        // Load products (bao g·ªìm c·∫£ s·∫£n ph·∫©m ·∫©n)
        async function loadProducts() {
            try {
                const response = await fetch(`${window.API_BASE_URL}/products?includeHidden=true`);
                const products = await response.json();
                
                const tbody = document.querySelector('#productsTable tbody');
                tbody.innerHTML = '';
                
                if (products.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center">Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o</td></tr>';
                    return;
                }
                
                products.forEach(product => {
                    const imageUrl = product.image ? `http://localhost:3000${product.image}` : 'images/products/default.jpg';
                    const statusBadge = product.is_active ? 
                        '<span class="badge bg-success">Hi·ªÉn th·ªã</span>' : 
                        '<span class="badge bg-secondary">ƒê√£ ·∫©n</span>';
                    
                    const toggleButton = product.is_active ?
                        `<button class="btn btn-sm btn-warning me-1" onclick="toggleProductVisibility(${product.product_id}, false, '${escapeHtml(product.product_name)}')" title="·∫®n s·∫£n ph·∫©m">
                            <i class="fas fa-eye-slash"></i>
                        </button>` :
                        `<button class="btn btn-sm btn-success me-1" onclick="toggleProductVisibility(${product.product_id}, true, '${escapeHtml(product.product_name)}')" title="Hi·ªÉn th·ªã s·∫£n ph·∫©m">
                            <i class="fas fa-eye"></i>
                        </button>`;
                    
                    const row = document.createElement('tr');
                    if (!product.is_active) row.style.opacity = '0.6';
                    row.innerHTML = `
                        <td>${product.product_id}</td>
                        <td><img src="${imageUrl}" alt="${product.product_name}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 5px;" onerror="this.src='images/products/default.jpg'"></td>
                        <td>
                            <strong>${product.product_name}</strong><br>
                            <small class="text-muted">SKU: ${product.sku || 'N/A'}</small>
                        </td>
                        <td>
                            ${formatPrice(product.price)}<br>
                            ${product.sale_price && product.sale_price < product.price ? 
                                `<small class="text-success">KM: ${formatPrice(product.sale_price)}</small>` : 
                                ''}
                        </td>
                        <td>
                            <span class="badge ${product.stock_quantity > 0 ? 'bg-success' : 'bg-danger'}">
                                ${product.stock_quantity}
                            </span>
                        </td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="btn btn-sm btn-info me-1" onclick="editProduct(${product.product_id})" title="S·ª≠a s·∫£n ph·∫©m">
                                <i class="fas fa-edit"></i>
                            </button>
                            ${toggleButton}
                            <button class="btn btn-sm btn-danger" onclick="deleteProduct(${product.product_id}, '${escapeHtml(product.product_name)}')" title="X√≥a s·∫£n ph·∫©m">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                console.log('‚úÖ Products loaded successfully');
            } catch (error) {
                console.error('Error loading products:', error);
                document.querySelector('#productsTable tbody').innerHTML = 
                    '<tr><td colspan="7" class="text-center text-danger">L·ªói t·∫£i d·ªØ li·ªáu: ' + error.message + '</td></tr>';
            }
        }

        function formatPrice(price) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(price);
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // Toggle product visibility (·∫©n/hi·ªán s·∫£n ph·∫©m)
        async function toggleProductVisibility(productId, isActive, productName) {
            const action = isActive ? 'hi·ªÉn th·ªã' : '·∫©n';
            
            if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën ${action} s·∫£n ph·∫©m "${productName}"?\n\n${isActive ? 'S·∫£n ph·∫©m s·∫Ω xu·∫•t hi·ªán trong trang mua s·∫Øm.' : 'S·∫£n ph·∫©m s·∫Ω t·∫°m th·ªùi bi·∫øn m·∫•t kh·ªèi trang mua s·∫Øm.'}`)) {
                return;
            }
            
            try {
                const response = await fetch(`${window.API_BASE_URL}/products/${productId}/visibility`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ is_active: isActive })
                });
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'L·ªói c·∫≠p nh·∫≠t tr·∫°ng th√°i');
                }
                
                alert(data.message);
                loadProducts();
                
            } catch (error) {
                alert('L·ªói: ' + error.message);
            }
        }

        // Edit product
        async function editProduct(productId) {
            try {
                console.log('üìù Loading product for edit:', productId);
                const response = await fetch(`${window.API_BASE_URL}/products/${productId}`);
                
                if (!response.ok) {
                    throw new Error('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin s·∫£n ph·∫©m');
                }
                
                const product = await response.json();
                console.log('üì¶ Product data:', product);
                
                // Fill form
                document.getElementById('edit_product_id').value = product.product_id;
                document.getElementById('edit_product_name').value = product.product_name;
                document.getElementById('edit_sku').value = product.sku;
                document.getElementById('edit_category_id').value = product.category_id;
                document.getElementById('edit_stock_quantity').value = product.stock_quantity;
                document.getElementById('edit_price').value = product.sale_price || product.price;
                document.getElementById('edit_sale_price').value = product.price !== product.sale_price ? product.price : '';
                document.getElementById('edit_short_description').value = product.short_description || '';
                document.getElementById('edit_description').value = product.description || '';
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('editProductModal'));
                modal.show();
                
            } catch (error) {
                console.error('‚ùå Error loading product:', error);
                alert('L·ªói t·∫£i th√¥ng tin s·∫£n ph·∫©m: ' + error.message);
            }
        }

        // Save product edit
        async function saveProductEdit() {
            try {
                const productId = document.getElementById('edit_product_id').value;
                const productName = document.getElementById('edit_product_name').value;
                const price = parseFloat(document.getElementById('edit_price').value);
                const salePrice = document.getElementById('edit_sale_price').value ? 
                    parseFloat(document.getElementById('edit_sale_price').value) : null;
                
                // Validate
                if (!productName) {
                    alert('Vui l√≤ng nh·∫≠p t√™n s·∫£n ph·∫©m');
                    return;
                }
                
                if (price <= 0) {
                    alert('Gi√° s·∫£n ph·∫©m ph·∫£i l·ªõn h∆°n 0');
                    return;
                }
                
                if (salePrice && salePrice >= price) {
                    alert('Gi√° khuy·∫øn m√£i ph·∫£i nh·ªè h∆°n gi√° g·ªëc');
                    return;
                }
                
                const productData = {
                    product_name: productName,
                    product_slug: generateSlug(productName),
                    sku: document.getElementById('edit_sku').value,
                    category_id: document.getElementById('edit_category_id').value,
                    stock_quantity: parseInt(document.getElementById('edit_stock_quantity').value),
                    price: price,
                    sale_price: salePrice,
                    short_description: document.getElementById('edit_short_description').value,
                    description: document.getElementById('edit_description').value
                };
                
                console.log('üíæ Saving product:', productData);
                
                const response = await fetch(`${window.API_BASE_URL}/products/${productId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(productData)
                });
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'L·ªói c·∫≠p nh·∫≠t s·∫£n ph·∫©m');
                }
                
                alert('‚úÖ ƒê√£ c·∫≠p nh·∫≠t s·∫£n ph·∫©m th√†nh c√¥ng!');
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('editProductModal'));
                modal.hide();
                
                // Reload products
                loadProducts();
                
            } catch (error) {
                console.error('‚ùå Error saving product:', error);
                alert('L·ªói c·∫≠p nh·∫≠t s·∫£n ph·∫©m: ' + error.message);
            }
        }

        // Delete product
        async function deleteProduct(productId, productName) {
            if (!confirm(`‚ö†Ô∏è B·∫†N C√ì CH·∫ÆC MU·ªêN X√ìA Vƒ®NH VI·ªÑN S·∫¢N PH·∫®M N√ÄY?\n\nT√™n: ${productName}\n\n‚ùå Sau khi x√≥a:\n‚Ä¢ S·∫£n ph·∫©m s·∫Ω b·ªã x√≥a ho√†n to√†n\n‚Ä¢ Kh√¥ng th·ªÉ kh√¥i ph·ª•c\n‚Ä¢ ·∫¢nh s·∫£n ph·∫©m s·∫Ω b·ªã x√≥a\n‚Ä¢ ƒê√°nh gi√° s·∫Ω b·ªã x√≥a\n\nüí° N·∫øu ch·ªâ mu·ªën t·∫°m ·∫©n, h√£y d√πng n√∫t "·∫®n" thay v√¨ x√≥a!`)) {
                return;
            }
            
            // Double confirm
            if (!confirm(`X√°c nh·∫≠n l·∫ßn cu·ªëi: X√≥a s·∫£n ph·∫©m "${productName}"?`)) {
                return;
            }
            
            try {
                console.log('üóëÔ∏è Deleting product:', productId);
                const response = await fetch(`${window.API_BASE_URL}/products/${productId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'L·ªói x√≥a s·∫£n ph·∫©m');
                }
                
                alert('‚úÖ ƒê√£ x√≥a s·∫£n ph·∫©m th√†nh c√¥ng!');
                loadProducts();
                
            } catch (error) {
                console.error('‚ùå Error deleting product:', error);
                alert('‚ùå L·ªói x√≥a s·∫£n ph·∫©m: ' + error.message);
            }
        }

        // Generate slug from product name
        function generateSlug(text) {
            return text
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/ƒë/g, 'd')
                .replace(/[^a-z0-9\s-]/g, '')
                .trim()
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-');
        }

        // Load products on page load
        loadProducts();
    </script>
</body>
</html>
