<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý sản phẩm - GOOJODOQ Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1><i class="fas fa-box me-2"></i>Quản lý sản phẩm</h1>
                    <div>
                        <a href="add-product.html" class="btn btn-success me-2">
                            <i class="fas fa-plus me-2"></i>Thêm sản phẩm
                        </a>
                        <a href="index.html" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Quay lại
                        </a>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="productsTable">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Hình ảnh</th>
                                        <th>Tên sản phẩm</th>
                                        <th>Giá</th>
                                        <th>Tồn kho</th>
                                        <th>Trạng thái</th>
                                        <th>Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="7" class="text-center">Đang tải dữ liệu...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/main.js"></script>
    <script>
        // Check if user is admin
        const currentUser = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || 'null');
        if (!currentUser || currentUser.quyen !== 'admin') {
            alert('Bạn không có quyền truy cập trang này!');
            window.location.href = 'index.html';
        }

        // Load products (bao gồm cả sản phẩm ẩn)
        async function loadProducts() {
            try {
                const response = await fetch(`${window.API_BASE_URL}/products?includeHidden=true`);
                const products = await response.json();
                
                const tbody = document.querySelector('#productsTable tbody');
                tbody.innerHTML = '';
                
                if (products.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center">Chưa có sản phẩm nào</td></tr>';
                    return;
                }
                
                products.forEach(product => {
                    const imageUrl = product.image ? `http://localhost:3000${product.image}` : 'images/products/default.jpg';
                    const statusBadge = product.is_active ? 
                        '<span class="badge bg-success">Hiển thị</span>' : 
                        '<span class="badge bg-secondary">Đã ẩn</span>';
                    
                    const toggleButton = product.is_active ?
                        `<button class="btn btn-sm btn-warning" onclick="toggleProductVisibility(${product.product_id}, false, '${escapeHtml(product.product_name)}')" title="Ẩn sản phẩm">
                            <i class="fas fa-eye-slash"></i>
                        </button>` :
                        `<button class="btn btn-sm btn-success" onclick="toggleProductVisibility(${product.product_id}, true, '${escapeHtml(product.product_name)}')" title="Hiển thị sản phẩm">
                            <i class="fas fa-eye"></i>
                        </button>`;
                    
                    tbody.innerHTML += `
                        <tr ${!product.is_active ? 'style="opacity: 0.6;"' : ''}>
                            <td>${product.product_id}</td>
                            <td><img src="${imageUrl}" alt="${product.product_name}" style="width: 50px; height: 50px; object-fit: cover;" onerror="this.src='images/products/default.jpg'"></td>
                            <td>${product.product_name}</td>
                            <td>${formatPrice(product.price)}</td>
                            <td>${product.stock_quantity}</td>
                            <td>${statusBadge}</td>
                            <td>
                                ${toggleButton}
                                <button class="btn btn-sm btn-danger" onclick="deleteProduct(${product.product_id}, '${escapeHtml(product.product_name)}')" title="Xóa sản phẩm">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
            } catch (error) {
                console.error('Error loading products:', error);
                document.querySelector('#productsTable tbody').innerHTML = 
                    '<tr><td colspan="7" class="text-center text-danger">Lỗi tải dữ liệu: ' + error.message + '</td></tr>';
            }
        }

        function formatPrice(price) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(price);
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // Toggle product visibility (ẩn/hiện sản phẩm)
        async function toggleProductVisibility(productId, isActive, productName) {
            const action = isActive ? 'hiển thị' : 'ẩn';
            
            if (!confirm(`Bạn có chắc muốn ${action} sản phẩm "${productName}"?\n\n${isActive ? 'Sản phẩm sẽ xuất hiện trong trang mua sắm.' : 'Sản phẩm sẽ tạm thời biến mất khỏi trang mua sắm.'}`)) {
                return;
            }
            
            try {
                const response = await fetch(`${window.API_BASE_URL}/products/${productId}/visibility`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ is_active: isActive })
                });
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Lỗi cập nhật trạng thái');
                }
                
                alert(data.message);
                loadProducts();
                
            } catch (error) {
                alert('Lỗi: ' + error.message);
            }
        }

        // Delete product
        async function deleteProduct(productId, productName) {
            if (!confirm(`Bạn có chắc muốn XÓA VĨNH VIỄN sản phẩm "${productName}"?\n\nSản phẩm sẽ bị xóa hoàn toàn khỏi cơ sở dữ liệu và không thể khôi phục.\n\nNếu bạn chỉ muốn tạm ẩn sản phẩm, hãy sử dụng nút "Ẩn" thay vì xóa.`)) {
                return;
            }
            
            try {
                const response = await fetch(`${window.API_BASE_URL}/products/${productId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Lỗi xóa sản phẩm');
                }
                
                alert('Đã xóa sản phẩm thành công!');
                loadProducts();
                
            } catch (error) {
                alert('Lỗi xóa sản phẩm: ' + error.message);
            }
        }

        loadProducts();
    </script>
</body>
</html>
