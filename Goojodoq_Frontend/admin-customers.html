<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω kh√°ch h√†ng - GOOJODOQ Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1><i class="fas fa-users me-2"></i>Qu·∫£n l√Ω kh√°ch h√†ng</h1>
                    <a href="index.html" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Quay l·∫°i
                    </a>
                </div>

                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="customersTable">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>H·ªç t√™n</th>
                                        <th>Email</th>
                                        <th>S·ªë ƒëi·ªán tho·∫°i</th>
                                        <th>Ng√†y ƒëƒÉng k√Ω</th>
                                        <th>Tr·∫°ng th√°i</th>
                                        <th>Thao t√°c</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="8" class="text-center">ƒêang t·∫£i d·ªØ li·ªáu...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal xem th√¥ng tin ng∆∞·ªùi d√πng -->
    <div class="modal fade" id="userDetailModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Th√¥ng tin ng∆∞·ªùi d√πng</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="userDetailContent">
                    <!-- Content will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/main.js"></script>
    <script>
        // Check if user is admin (currentUser ƒë√£ ƒë∆∞·ª£c khai b√°o trong main.js)
        if (!currentUser || currentUser.quyen !== 'admin') {
            alert('B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y!');
            window.location.href = 'index.html';
        }

        // Load customers
        async function loadCustomers() {
            try {
                console.log('üîÑ Loading customers...');
                const response = await fetch(`${window.API_BASE_URL}/auth/users`);
                console.log('üì° Response status:', response.status);
                
                const data = await response.json();
                console.log('üì¶ Data received:', data);
                
                if (!data.success) {
                    throw new Error(data.message || 'Kh√¥ng th·ªÉ t·∫£i danh s√°ch kh√°ch h√†ng');
                }
                
                const tbody = document.querySelector('#customersTable tbody');
                tbody.innerHTML = '';
                
                if (!data.users || data.users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center">Ch∆∞a c√≥ kh√°ch h√†ng n√†o</td></tr>';
                    return;
                }
                
                console.log('üë• Total users:', data.users.length);
                
                data.users.forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${user.id_nguoidung}</td>
                        <td>${user.hoten || '<em class="text-muted">Ch∆∞a c·∫≠p nh·∫≠t</em>'}</td>
                        <td>${user.email}</td>
                        <td>${user.sdt || '<em class="text-muted">Ch∆∞a c·∫≠p nh·∫≠t</em>'}</td>
                        <td>${new Date(user.ngay_tao).toLocaleDateString('vi-VN', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        })}</td>
                        <td>
                            ${user.trangthai === 1 ? 
                                '<span class="badge bg-success">Ho·∫°t ƒë·ªông</span>' : 
                                '<span class="badge bg-danger">ƒê√£ kh√≥a</span>'}
                        </td>
                        <td>
                            <button class="btn btn-sm btn-info me-1" onclick="viewUserDetail(${user.id_nguoidung})" title="Xem chi ti·∫øt">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-primary me-1" onclick="viewUserProfile(${user.id_nguoidung})" title="Xem trang c√° nh√¢n">
                                <i class="fas fa-user"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id_nguoidung}, '${escapeHtml(user.email)}')" title="X√≥a ng∆∞·ªùi d√πng">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                console.log('‚úÖ Customers loaded successfully');
                
            } catch (error) {
                console.error('‚ùå Error loading customers:', error);
                document.querySelector('#customersTable tbody').innerHTML = 
                    `<tr><td colspan="7" class="text-center text-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        L·ªói t·∫£i d·ªØ li·ªáu: ${error.message}
                    </td></tr>`;
            }
        }

        // View user detail in modal
        async function viewUserDetail(userId) {
            try {
                console.log('üîç Loading user detail:', userId);
                const response = await fetch(`${window.API_BASE_URL}/profile/${userId}`);
                
                if (!response.ok) {
                    throw new Error('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin ng∆∞·ªùi d√πng');
                }
                
                const data = await response.json();
                console.log('üì¶ User data:', data);
                
                const user = data.user;
                const address = data.address;
                
                let content = `
                    <div class="row g-3">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0"><i class="fas fa-user me-2"></i>Th√¥ng tin c∆° b·∫£n</h6>
                                </div>
                                <div class="card-body">
                                    <table class="table table-borderless mb-0">
                                        <tr>
                                            <td width="40%"><strong>ID:</strong></td>
                                            <td>${user.id_nguoidung}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>H·ªç t√™n:</strong></td>
                                            <td>${user.hoten || '<em class="text-muted">Ch∆∞a c·∫≠p nh·∫≠t</em>'}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Email:</strong></td>
                                            <td>${user.email}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>S·ªë ƒëi·ªán tho·∫°i:</strong></td>
                                            <td>${user.sdt || '<em class="text-muted">Ch∆∞a c·∫≠p nh·∫≠t</em>'}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Ng√†y ƒëƒÉng k√Ω:</strong></td>
                                            <td>${new Date(user.ngay_tao).toLocaleString('vi-VN')}</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                `;
                
                if (address) {
                    content += `
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0"><i class="fas fa-map-marker-alt me-2"></i>ƒê·ªãa ch·ªâ</h6>
                                </div>
                                <div class="card-body">
                                    <table class="table table-borderless mb-0">
                                        <tr>
                                            <td width="40%"><strong>Ng∆∞·ªùi nh·∫≠n:</strong></td>
                                            <td>${address.ten_nguoinhan || '<em class="text-muted">Ch∆∞a c·∫≠p nh·∫≠t</em>'}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>S·ªë ƒëi·ªán tho·∫°i:</strong></td>
                                            <td>${address.sdt || '<em class="text-muted">Ch∆∞a c·∫≠p nh·∫≠t</em>'}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>ƒê·ªãa ch·ªâ:</strong></td>
                                            <td>${address.diachi_chitiet || '<em class="text-muted">Ch∆∞a c·∫≠p nh·∫≠t</em>'}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Qu·∫≠n/Huy·ªán:</strong></td>
                                            <td>${address.quanhuyen || '<em class="text-muted">Ch∆∞a c·∫≠p nh·∫≠t</em>'}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Th√†nh ph·ªë:</strong></td>
                                            <td>${address.thanhpho || '<em class="text-muted">Ch∆∞a c·∫≠p nh·∫≠t</em>'}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>M√£ b∆∞u ƒëi·ªán:</strong></td>
                                            <td>${address.ma_buudien || '<em class="text-muted">Ch∆∞a c·∫≠p nh·∫≠t</em>'}</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    content += `
                        <div class="col-12">
                            <div class="alert alert-info mb-0">
                                <i class="fas fa-info-circle me-2"></i>
                                Ng∆∞·ªùi d√πng ch∆∞a c·∫≠p nh·∫≠t ƒë·ªãa ch·ªâ
                            </div>
                        </div>
                    `;
                }
                
                content += `</div>`;
                
                document.getElementById('userDetailContent').innerHTML = content;
                const modal = new bootstrap.Modal(document.getElementById('userDetailModal'));
                modal.show();
                
            } catch (error) {
                console.error('‚ùå Error loading user detail:', error);
                alert('L·ªói t·∫£i th√¥ng tin ng∆∞·ªùi d√πng: ' + error.message);
            }
        }

        // View user profile page
        function viewUserProfile(userId) {
            window.open(`profile.html?userId=${userId}`, '_blank');
        }

        // Delete user
        async function deleteUser(userId, email) {
            if (!confirm(`‚ö†Ô∏è B·∫†N C√ì CH·∫ÆC MU·ªêN X√ìA T√ÄI KHO·∫¢N N√ÄY?\n\nEmail: ${email}\n\n‚ùå Sau khi x√≥a:\n‚Ä¢ Ng∆∞·ªùi d√πng kh√¥ng th·ªÉ ƒëƒÉng nh·∫≠p\n‚Ä¢ Gi·ªè h√†ng s·∫Ω b·ªã x√≥a\n‚Ä¢ Danh s√°ch y√™u th√≠ch s·∫Ω b·ªã x√≥a\n‚Ä¢ ƒê√°nh gi√° s·∫Ω b·ªã x√≥a\n‚Ä¢ ƒê∆°n h√†ng s·∫Ω ƒë∆∞·ª£c ƒë√°nh d·∫•u [T√†i kho·∫£n ƒë√£ b·ªã x√≥a]\n\nH√†nh ƒë·ªông n√†y KH√îNG TH·ªÇ HO√ÄN T√ÅC!`)) {
                return;
            }
            
            // Double confirm
            if (!confirm(`X√°c nh·∫≠n l·∫ßn cu·ªëi: X√≥a t√†i kho·∫£n "${email}"?`)) {
                return;
            }
            
            try {
                console.log('üóëÔ∏è Deleting user:', userId);
                const response = await fetch(`${window.API_BASE_URL}/auth/user/${userId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                console.log('üì¶ Delete response:', data);
                
                if (!data.success) {
                    throw new Error(data.message || 'Kh√¥ng th·ªÉ x√≥a ng∆∞·ªùi d√πng');
                }
                
                alert('‚úÖ ƒê√£ x√≥a t√†i kho·∫£n th√†nh c√¥ng!');
                loadCustomers();
                
            } catch (error) {
                console.error('‚ùå Error deleting user:', error);
                alert('‚ùå L·ªói x√≥a t√†i kho·∫£n: ' + error.message);
            }
        }

        // Helper function to escape HTML
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // Load customers on page load
        loadCustomers();
    </script>
</body>
</html>
