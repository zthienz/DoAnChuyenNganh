<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Payment - GOOJODOQ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .debug-container {
            padding: 20px 0;
            min-height: 100vh;
            background: #f8f9fa;
        }
        .debug-card {
            background: white;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .log-output {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .btn-test {
            margin: 5px;
        }
    </style>
</head>
<body>
    <div class="debug-container">
        <div class="container">
            <h1 class="text-center mb-4">
                <i class="fas fa-bug me-2"></i>Debug Payment System
            </h1>

            <!-- Test Data Card -->
            <div class="debug-card">
                <h3><i class="fas fa-database me-2"></i>Test Data</h3>
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label">Order ID:</label>
                        <input type="number" id="orderId" class="form-control" value="125">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Order Code:</label>
                        <input type="number" id="orderCode" class="form-control" value="37130988125">
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <label class="form-label">Status:</label>
                        <select id="paymentStatus" class="form-control">
                            <option value="PAID">PAID</option>
                            <option value="CANCELLED">CANCELLED</option>
                            <option value="PENDING">PENDING</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Code:</label>
                        <input type="text" id="responseCode" class="form-control" value="00">
                    </div>
                </div>
            </div>

            <!-- Test Actions Card -->
            <div class="debug-card">
                <h3><i class="fas fa-play me-2"></i>Test Actions</h3>
                <div class="d-flex flex-wrap">
                    <button class="btn btn-primary btn-test" onclick="checkOrderStatus()">
                        <i class="fas fa-search me-1"></i>Check Order Status
                    </button>
                    <button class="btn btn-warning btn-test" onclick="triggerWebhook()">
                        <i class="fas fa-webhook me-1"></i>Trigger Webhook
                    </button>
                    <button class="btn btn-info btn-test" onclick="checkPaymentStatus()">
                        <i class="fas fa-credit-card me-1"></i>Check Payment Status
                    </button>
                    <button class="btn btn-success btn-test" onclick="testFullFlow()">
                        <i class="fas fa-rocket me-1"></i>Test Full Flow
                    </button>
                    <button class="btn btn-secondary btn-test" onclick="clearLog()">
                        <i class="fas fa-trash me-1"></i>Clear Log
                    </button>
                </div>
            </div>

            <!-- Log Output Card -->
            <div class="debug-card">
                <h3><i class="fas fa-terminal me-2"></i>Debug Log</h3>
                <div id="logOutput" class="log-output">
                    === PayOS Payment Debug Tool ===
                    Ready to test...
                </div>
            </div>

            <!-- Quick Links -->
            <div class="debug-card">
                <h3><i class="fas fa-link me-2"></i>Quick Links</h3>
                <div class="d-flex flex-wrap">
                    <a href="orders.html" class="btn btn-outline-primary btn-test">
                        <i class="fas fa-list me-1"></i>View Orders
                    </a>
                    <a href="payment-success.html?orderId=125&code=00&status=PAID&orderCode=37130988125" class="btn btn-outline-success btn-test">
                        <i class="fas fa-check me-1"></i>Test Success Page
                    </a>
                    <a href="index.html" class="btn btn-outline-secondary btn-test">
                        <i class="fas fa-home me-1"></i>Back to Home
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE_URL = 'http://localhost:3000/api';

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logOutput = document.getElementById('logOutput');
            const color = {
                'info': '#00ff00',
                'error': '#ff0000',
                'warning': '#ffff00',
                'success': '#00ff00'
            }[type] || '#00ff00';
            
            logOutput.innerHTML += `\n[${timestamp}] <span style="color: ${color}">${message}</span>`;
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        function clearLog() {
            document.getElementById('logOutput').innerHTML = '=== PayOS Payment Debug Tool ===\nLog cleared...';
        }

        function getTestData() {
            return {
                orderId: document.getElementById('orderId').value,
                orderCode: document.getElementById('orderCode').value,
                status: document.getElementById('paymentStatus').value,
                code: document.getElementById('responseCode').value
            };
        }

        async function checkOrderStatus() {
            const data = getTestData();
            log(`üîç Checking order status for ID: ${data.orderId}`, 'info');

            try {
                const response = await fetch(`${API_BASE_URL}/orders/detail/${data.orderId}`);
                
                if (response.ok) {
                    const orderData = await response.json();
                    log(`‚úÖ Order found: ${orderData.ma_donhang}`, 'success');
                    log(`üìã Status: ${orderData.trangthai}`, 'info');
                    log(`üí≥ Payment Status: ${orderData.trangthai_thanhtoan}`, 'info');
                    log(`üí∞ Payment Method: ${orderData.phuongthuc_thanhtoan}`, 'info');
                    log(`üíµ Total: ${orderData.tong_tien} VND`, 'info');
                } else {
                    log(`‚ùå Order not found: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function triggerWebhook() {
            const data = getTestData();
            log(`üîî Triggering webhook for order code: ${data.orderCode}`, 'info');

            const webhookData = {
                orderCode: parseInt(data.orderCode),
                code: data.code,
                desc: data.status === 'PAID' ? 'Payment successful - Manual test' : 'Payment cancelled - Manual test',
                success: data.status === 'PAID'
            };

            log(`üì§ Webhook data: ${JSON.stringify(webhookData)}`, 'info');

            try {
                const response = await fetch(`${API_BASE_URL}/payment/webhook`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(webhookData)
                });

                if (response.ok) {
                    const result = await response.json();
                    log(`‚úÖ Webhook success: ${JSON.stringify(result)}`, 'success');
                } else {
                    const errorText = await response.text();
                    log(`‚ùå Webhook failed: ${response.status} - ${errorText}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Webhook error: ${error.message}`, 'error');
            }
        }

        async function checkPaymentStatus() {
            const data = getTestData();
            log(`üí≥ Checking payment status for order code: ${data.orderCode}`, 'info');

            try {
                const response = await fetch(`${API_BASE_URL}/payment/status/${data.orderCode}`);
                
                if (response.ok) {
                    const result = await response.json();
                    log(`‚úÖ Payment status: ${JSON.stringify(result, null, 2)}`, 'success');
                } else {
                    const errorText = await response.text();
                    log(`‚ùå Payment status check failed: ${response.status} - ${errorText}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Payment status error: ${error.message}`, 'error');
            }
        }

        async function testFullFlow() {
            log(`üöÄ Starting full payment test flow...`, 'info');
            log(`===============================`, 'info');

            // Step 1: Check initial order status
            log(`1Ô∏è‚É£ Checking initial order status...`, 'info');
            await checkOrderStatus();
            
            await new Promise(resolve => setTimeout(resolve, 1000));

            // Step 2: Trigger webhook
            log(`\n2Ô∏è‚É£ Triggering webhook...`, 'info');
            await triggerWebhook();
            
            await new Promise(resolve => setTimeout(resolve, 1000));

            // Step 3: Check final order status
            log(`\n3Ô∏è‚É£ Checking final order status...`, 'info');
            await checkOrderStatus();
            
            await new Promise(resolve => setTimeout(resolve, 1000));

            // Step 4: Check payment status
            log(`\n4Ô∏è‚É£ Checking payment status...`, 'info');
            await checkPaymentStatus();

            log(`\nüéâ Full flow test completed!`, 'success');
            log(`===============================`, 'info');
        }

        // Auto-populate from URL if available
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            
            if (urlParams.get('orderId')) {
                document.getElementById('orderId').value = urlParams.get('orderId');
            }
            if (urlParams.get('orderCode')) {
                document.getElementById('orderCode').value = urlParams.get('orderCode');
            }
            if (urlParams.get('status')) {
                document.getElementById('paymentStatus').value = urlParams.get('status');
            }
            if (urlParams.get('code')) {
                document.getElementById('responseCode').value = urlParams.get('code');
            }

            log('üîß Debug tool loaded successfully!', 'success');
            log('üí° Tip: Use the buttons above to test different scenarios', 'info');
        });
    </script>
</body>
</html>