<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tổng doanh thu - GOOJODOQ Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1><i class="fas fa-chart-line me-2"></i>Tổng doanh thu</h1>
                    <a href="index.html" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Quay lại
                    </a>
                </div>

                <!-- Filter -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <label class="form-label">Loại thống kê:</label>
                                <select class="form-select" id="filterType" onchange="loadRevenue()">
                                    <option value="day">Theo ngày</option>
                                    <option value="month">Theo tháng</option>
                                    <option value="year">Theo năm</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Từ ngày:</label>
                                <input type="date" class="form-control" id="fromDate">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Đến ngày:</label>
                                <input type="date" class="form-control" id="toDate">
                            </div>
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-primary" onclick="loadRevenue()">
                                <i class="fas fa-search me-2"></i>Tìm kiếm
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Summary Cards -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card text-white bg-primary">
                            <div class="card-body">
                                <h5 class="card-title">Tổng đơn hàng</h5>
                                <h2 id="totalOrders">0</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-white bg-success">
                            <div class="card-body">
                                <h5 class="card-title">Đơn thành công</h5>
                                <h2 id="successOrders">0</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-white bg-danger">
                            <div class="card-body">
                                <h5 class="card-title">Đơn đã hủy</h5>
                                <h2 id="canceledOrders">0</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-white bg-info">
                            <div class="card-body">
                                <h5 class="card-title">Tổng doanh thu</h5>
                                <h2 id="totalRevenue">0₫</h2>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Revenue Table -->
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Chi tiết doanh thu</h5>
                        <div class="table-responsive">
                            <table class="table table-hover" id="revenueTable">
                                <thead>
                                    <tr>
                                        <th>Thời gian</th>
                                        <th>Số đơn</th>
                                        <th>Doanh thu</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="3" class="text-center">Đang tải dữ liệu...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/main.js"></script>
    <script>
        // Check if user is admin
        const currentUser = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || 'null');
        if (!currentUser || currentUser.quyen !== 'admin') {
            alert('Bạn không có quyền truy cập trang này!');
            window.location.href = 'index.html';
        }

        // Set default dates
        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        document.getElementById('fromDate').valueAsDate = firstDay;
        document.getElementById('toDate').valueAsDate = today;

        // Load revenue
        async function loadRevenue() {
            try {
                const response = await fetch(`${window.API_BASE_URL}/orders`);
                const orders = await response.json();
                
                // Calculate statistics
                const totalOrders = orders.length;
                const successOrders = orders.filter(o => o.trang_thai === 'da_giao').length;
                const canceledOrders = orders.filter(o => o.trang_thai === 'da_huy').length;
                const totalRevenue = orders
                    .filter(o => o.trang_thai === 'da_giao')
                    .reduce((sum, o) => sum + parseFloat(o.tong_tien), 0);
                
                // Update summary cards
                document.getElementById('totalOrders').textContent = totalOrders;
                document.getElementById('successOrders').textContent = successOrders;
                document.getElementById('canceledOrders').textContent = canceledOrders;
                document.getElementById('totalRevenue').textContent = formatPrice(totalRevenue);
                
                // Update table
                const tbody = document.querySelector('#revenueTable tbody');
                tbody.innerHTML = '';
                
                // Group by date
                const revenueByDate = {};
                orders.forEach(order => {
                    if (order.trang_thai === 'da_giao') {
                        const date = new Date(order.ngay_tao).toLocaleDateString('vi-VN');
                        if (!revenueByDate[date]) {
                            revenueByDate[date] = { count: 0, revenue: 0 };
                        }
                        revenueByDate[date].count++;
                        revenueByDate[date].revenue += parseFloat(order.tong_tien);
                    }
                });
                
                // Display in table
                Object.keys(revenueByDate).forEach(date => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${date}</td>
                            <td>${revenueByDate[date].count}</td>
                            <td>${formatPrice(revenueByDate[date].revenue)}</td>
                        </tr>
                    `;
                });
                
                if (Object.keys(revenueByDate).length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" class="text-center">Chưa có dữ liệu</td></tr>';
                }
                
            } catch (error) {
                console.error('Error loading revenue:', error);
                document.querySelector('#revenueTable tbody').innerHTML = 
                    '<tr><td colspan="3" class="text-center text-danger">Lỗi tải dữ liệu</td></tr>';
            }
        }

        function formatPrice(price) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(price);
        }

        loadRevenue();
    </script>
</body>
</html>
